{% extends "base.html" %}
{% block content %}
<h2>{{ topic.name }}</h2>

<div class="chatbox" id="chatbox">
  {% for m in msgs %}
    <div class="msg">
      <div class="header">
        <span class="who">{{ m.sender }}:</span>
        <span class="ts">{{ m.created.strftime('%H:%M %Y-%m-%d') }}</span>
      </div>
      <div class="txt">{{ m.body|safe }}</div>
    </div>
  {% endfor %}
</div>

<form id="msgForm" class="send">
    <input name="sender" id="sender" placeholder="Your name (optional)">
    <textarea name="body" id="body" rows="3" placeholder="Type messageâ€¦"></textarea>
    <button type="submit">Send</button>
</form>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  const room = "{{ topic.slug }}";
  const topicId = {{ topic.id }};
  socket.emit("join", { room });

  document.getElementById("msgForm").addEventListener("submit", e => {
    e.preventDefault();
    const sender = document.getElementById("sender").value;
    const body = document.getElementById("body").value;
    if (body.trim()) {
      socket.emit("send_message", {
        room: room,
        topic_id: topicId,
        sender: sender,
        body: body
      });
      document.getElementById("body").value = "";
    }
  });

  socket.on("new_message", data => {
    const box = document.getElementById("chatbox");
    const msg = document.createElement("div");
    msg.className = "msg";
    msg.innerHTML = `
      <div class="header">
        <span class="who">${data.sender}:</span>
        <span class="ts">${data.time}</span>
      </div>
      <div class="txt">${data.body}</div>
    `;
    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;
  });
</script>
{% endblock %}
